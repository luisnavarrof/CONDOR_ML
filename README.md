# CONDOR Machine Learning Models for Angular Reconstruction and Particle Identification

-- Explicación sobre CONDOR cocinándose --

## Data Types in the CONDOR Project
This repository processes two main types of data generated by the CONDOR detector simulations: particle data and binned data. Each serves a distinct purpose in understanding the distribution and behavior of particles generated during cosmic ray showers.

### Particle Data (or all-data)

Particle data contains detailed information about individual particles from the cosmic ray showers. This data includes:

- Spatial positions (x, y).
- Time of arrival (t).
- Energy (E).
- Particle type (particle_id).

These features capture the full distribution of particles, including their energies, providing a comprehensive view of the particle shower's dynamics as it interacts with the detector array.

_Use Case_:
Particle data is ideal for detailed modeling tasks, such as predicting the incident angle of the primary particle that initiated the shower, using models like LSTM.

### Binned Data
Binned data represents the particle distribution as a 2D histogram. It counts the number of particles hitting each square meter of the detector array (x_bin, y_bin) during specific time intervals (t_bin). Instead of individual particle details, it provides a summarized spatial and temporal view of the particle shower. This data includes:

- Spatial bins (x_bin, y_bin).
- Time bins (t_bin).
- Particle counts per bin (particle_count).

_Use Case_:
Binned data simplifies the input for models like LSTM or CNN, focusing on spatial and temporal patterns of particle distribution. It’s especially useful for predicting the incident angle in a less detailed, aggregated manner.

## Read Binary data

This script processes simulation data from cosmic ray showers detected by the CONDOR detector (a 113x112 m² array of detectors). It reads .DAT files, extracts particle information, and outputs two types of datasets before mentioned.

### For each .DAT file:

### Angle and Seed Mapping:

Angles are mapped in steps of 2° from 0° to 60°, depending on the file index.
Each group of 1000 files corresponds to a unique angle, with a specific seed number within the group.

### Reading and Filtering Data:

The script uses the panama library to read .DAT files and extracts relevant particle information (e.g., position x, y, time t, and energy E).
Filters particles by valid IDs, focusing on specific particle types like photons, protons, electrons, and muons.

### Scaling for CONDOR Dimensions:

x and y coordinates are scaled to meters (x/100, y/100) to simulate the CONDOR detector's physical area (113x112 m²).
Time (t) is normalized relative to the first detected particle.
Filtering by CONDOR Detector Area:

### Filters particles within the CONDOR detector's bounds:

x ∈ [-61, 61] and y ∈ [-56.5, 56.5] meters.

### Metadata Addition:

Adds relevant metadata to the particle data, such as:
Particle ID (photon = 1, proton = 14).
Incident energy.
Incident angle, seed, and simulation run ID.
Percentage of particles detected in the CONDOR area.

### Saving Particle Data:

Outputs detailed particle data as a .CSV file, sorted by time, into particles_data/run_x directories.

### Binning and Aggregation

#### Bin Creation:
Spatial bins: Floor of x and y coordinates (1 m² bins).
Temporal bins: Floor of t divided by a fixed time bin size (1 second).

#### Aggregation:
Groups particles by x_bin, y_bin, and t_bin, then counts the number of particles in each bin.

## LSTM (Long Short-Term Memory) Model

### PP_Identifier.py
This script uses a Convolutional Neural Network (CNN) to classify particles into protons or photons.

1. Loads _particle data_ from CSV files in specified directories, converts it into matrices, and normalizes them.
2. Splits the data into training and testing sets.
3. Builds a CNN to classify particles based on their features.

### AD_LSTM_Model_Training.py
This script uses an LSTM model to predict the incident angle of particles based on individual particle features.

1. Loads _particle data_, preprocesses it by scaling the features and creating time sequences.
2. Builds an LSTM model to predict the incident angle.


### Binned_LSTM_Model_Training.py
This script uses an LSTM model to predict the incident angle of particles based on binned particle data.

1. Loads _binned data_, preprocesses it by scaling and creating time sequences.
2. Builds an LSTM model to predict the incident angle using features like bin positions and particle counts.

## ResNet50 Model (Classifier)

### Image_Generator
This script generates heatmap images from binned particle data for use in machine learning models.

For each run_x folder:
Load binned data from CSV files and pivot the data to create a 2D heatmap (y_bin as rows, x_bin as columns, and particle_count as values).
Generate heatmaps using seaborn, with no titles, axes, or color bars, to ensure a clean visualization.
Save the heatmap as a .PNG image in the output directory.

### Model Training
This script trains a ResNet50-based regression model to predict the incident angle of particles using heatmap images generated by the Image_Generator.

Input: Heatmap images (Images_run_x folders).
Output: Prediction statistics saved as a CSV file.

Loads .PNG images and corresponding angles (extracted from file names) from each run folder.
Normalizes images to a size of 224x224 and scales pixel values to [0, 1].
Splits the data into training (70%) and validation (30%).
Model Definition:

Uses a pretrained ResNet50 (with imagenet weights) as the feature extractor.

**Adds**:
A global average pooling layer.
Dense layers for regression, with a single output for the predicted angle.

**Training**:
Optimizes the model using the Adam optimizer with Mean Squared Error (MSE) as the loss function.
Trains for 20 epochs with a batch size of 1.
